---
# tasks file for curry_certbot

- name: Install certbot
  community.general.snap:
    name: certbot
    classic: true
    options:
      - trust-plugin-with-root=ok

- name: Install certbot-dns-digitalocean
  community.general.snap:
    name: certbot-dns-digitalocean

- name: Create certbot secrets dir
  ansible.builtin.file:
    path: /root/.secrets/certbot/
    state: directory
    owner: root
    group: root
    mode: '0750'


- name: Include api_key vars
  ansible.builtin.include_vars:
    api_key.yaml


- name: Template digital ocean api_key ini
  ansible.builtin.template:
    src: secret-certbot-digitalocean.ini.j2
    dest: /root/.secrets/certbot/digitalocean.ini
    owner: root
    group: root
    mode: '0600'

- name: Include main vars
  ansible.builtin.include_vars:
    main.yaml

- name: Create cert via certbot digital ocean dns
  ansible.builtin.command:
    cmd: >
      /snap/bin/certbot certonly
      --email '{{ certbot_admin_email }}'
      --dns-digitalocean --dns-digitalocean-credentials {{ secrets_ini }}
      --noninteractive --agree-tos
      -d {{ dn_source }}
    creates: /etc/letsencrypt/live/{{ dn_source }}/cert.pem

- name: Enable renew 30 days before exipry
  ansible.builtin.lineinfile:
    dest: /etc/letsencrypt/renewal/{{ dn_source }}.conf
    regexp: '^# renew_before_expiry = 30 days'
    line: "renew_before_expiry = 30 days"
    state: present
    backup: true
  notify:
    - Restart certbot

- name: Copy nginx reload post hook
  ansible.builtin.copy:
    src: etc/letsencrypt/renewal-hooks/post/01_nginx-reload-post-hook.sh
    dest: /etc/letsencrypt/renewal-hooks/post/01_nginx-reload-post-hook.sh
    owner: root
    group: root
    mode: '0644'
